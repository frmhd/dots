#!/bin/bash

theme_name="$1"
theme_path="$HOME/dev/system/dots/themes/$theme_name"

# Validate theme exists
[[ ! -d "$theme_path" ]] && echo "Theme not found" && exit 1

# Switch theme symlink (atomic operation)
ln -snf "$theme_path" "$HOME/.config/omarchy/current/theme"

# Set first background
bg=$(find "$theme_path/backgrounds" -type f | head -n1)
ln -snf "$bg" "$HOME/.config/omarchy/current/background"

if [[ -f "$theme_path/light.mode" ]]; then
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita"
    gsettings set org.gnome.desktop.interface color-scheme "prefer-light"
else
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark"
fi

# Restart affected applications
killall -SIGUSR2 waybar  # Reload waybar

# Alacritty doesn't have reload signal, touch config to notify
touch ~/.config/alacritty/alacritty.toml
touch ~/.config/btop/btop.conf
touch ~/.config/btop/themes/current.theme

# Restart btop if running
pkill -SIGUSR2 btop 2>/dev/null || true  # SIGUSR1 triggers reload

pkill swayosd-server  # SIGUSR1 triggers reload
swayosd-server &

# Restart background
killall swaybg && swaybg -i $HOME/.config/omarchy/current/background -m fill &

CHROMIUM_THEME=~/.config/omarchy/current/theme/chromium.theme

if [[ -f $CHROMIUM_THEME ]]; then
THEME_RGB_COLOR=$(<$CHROMIUM_THEME)
THEME_HEX_COLOR=$(printf '#%02x%02x%02x' ${THEME_RGB_COLOR//,/ })
else
# Use a default, neutral grey if theme doesn't have a color
THEME_RGB_COLOR="28,32,39"
THEME_HEX_COLOR="#1c2027"
fi

echo "{\"BrowserThemeColor\": \"$THEME_HEX_COLOR\"}" | tee "/etc/brave/policies/managed/color.json" >/dev/null
brave --refresh-platform-policy --no-startup-window
